# 外部设备访问RAG API服务配置指南

## 📋 概述
本指南帮助你配置RAG API服务，使其他设备可以通过网络访问。

## 🛠️ 服务器端配置 (提供服务的电脑)

### 1. 启动API服务
```bash
# 在你的电脑上启动服务
.venv/Scripts/python.exe api_service.py
```

服务启动后会显示类似信息：
```
🚀 启动微信聊天记录API服务器...
============================================================
🏠 本地访问: http://localhost:8000
🌐 局域网访问: http://192.168.1.100:8000
📖 API文档: http://192.168.1.100:8000/docs
============================================================
📋 其他设备访问步骤:
1. 确保设备在同一局域网
2. 访问地址: http://192.168.1.100:8000
3. 如连接失败，请检查防火墙设置
============================================================
```

### 2. 防火墙配置

#### Windows防火墙:
1. 打开 "Windows Defender 防火墙"
2. 点击 "允许应用或功能通过 Windows Defender 防火墙"
3. 点击 "更改设置" → "允许其他应用"
4. 找到Python或添加端口8000的入站规则

#### 或者临时关闭防火墙进行测试:
```powershell
# 管理员权限运行
netsh advfirewall set allprofiles state off
# 测试完成后重新开启
netsh advfirewall set allprofiles state on
```

### 3. 获取本机IP地址
```bash
# Windows
ipconfig

# 查找类似 192.168.x.x 或 10.x.x.x 的地址
```

## 💻 客户端配置 (访问服务的电脑)

### 1. 安装依赖
```bash
pip install requests
```

### 2. 使用外部客户端
将 `external_client.py` 复制到客户端电脑，然后运行：
```bash
python external_client.py
```

### 3. 简单测试连接
```python
import requests

# 替换为服务器实际IP
server_ip = "192.168.1.100"
response = requests.get(f"http://{server_ip}:8000/")
print(response.json())
```

## 🌐 API使用示例

### 基本查询
```python
import requests

server_url = "http://192.168.1.100:8000"

# 查询聊天记录
response = requests.post(
    f"{server_url}/query_simple",
    params={
        "question": "张宏哲说了什么？",
        "max_results": 5
    }
)

data = response.json()
print(f"找到 {data['count']} 条记录")
for record in data['records']:
    print(f"发送者: {record['sender']}")
    print(f"时间: {record['time']}")
    print(f"内容: {record['content']}")
    print("-" * 40)
```

### JavaScript/Web 调用示例
```javascript
async function queryRAG(question) {
    const serverUrl = 'http://192.168.1.100:8000';

    try {
        const response = await fetch(`${serverUrl}/query_simple?question=${encodeURIComponent(question)}&max_results=5`, {
            method: 'POST'
        });

        const data = await response.json();
        console.log(`找到 ${data.count} 条记录:`, data.records);
        return data;
    } catch (error) {
        console.error('查询失败:', error);
    }
}

// 使用
queryRAG('志愿服务相关内容');
```

## 🔧 常见问题排查

### 连接失败
1. **检查网络连接**
   ```bash
   ping 192.168.1.100  # 替换为实际服务器IP
   ```

2. **检查端口是否开放**
   ```bash
   telnet 192.168.1.100 8000
   ```

3. **检查服务是否运行**
   ```bash
   # 在服务器端运行
   netstat -an | findstr :8000
   ```

### 防火墙问题
- Windows: 检查 Windows Defender 防火墙设置
- 路由器: 确保设备在同一子网
- 企业网络: 可能需要管理员权限

### 网络环境
- **同一局域网**: 设备必须连接到同一WiFi或网络
- **公网访问**: 需要配置端口转发（不推荐，安全风险）

## 📊 API端点说明

| 端点 | 方法 | 描述 |
|------|------|------|
| `/` | GET | 服务信息 |
| `/health` | GET | 健康检查 |
| `/stats` | GET | 数据统计 |
| `/query` | POST | 完整查询 |
| `/query_simple` | POST | 简化查询 |
| `/docs` | GET | API文档 |

## 🔒 安全注意事项

1. **仅在信任的网络使用**
2. **不要暴露到公网**
3. **考虑添加认证机制**
4. **生产环境请限制CORS域名**

## 📞 支持

如果遇到问题：
1. 检查服务器和客户端的IP地址是否正确
2. 确认防火墙设置
3. 验证网络连通性
4. 查看服务器日志输出